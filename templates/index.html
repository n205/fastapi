<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>価値観マッチング</title>
  <link rel="stylesheet" href="/static/style.css" />
</head>
<body>
  <h1>🧭 価値観マッチング：あなたに合う会社は？</h1>
  <h2>🧩 あなたに合いそうな会社ランキング（簡易）</h2>

  <div id="table-view"></div>
  <div id="card-view" style="display: none;"></div>

  <h4>以下の会社がどのくらい自分と似ているか、各項目ごとに回答してください</h4>

  <form id="preference-form"></form>

  <div id="more-section">
    <button id="more-button">もっと見る</button>
  </div>

  <script>
    const form = document.getElementById('preference-form');
    const tableView = document.getElementById('table-view');
    const cardView = document.getElementById('card-view');

    let questionOrder = []; // ランダムな順番

    function isMobile() {
      return window.innerWidth <= 768;
    }

    async function fetchQuestionsAndRenderForm() {
      try {
        const res = await fetch('/api/questions');
        const data = await res.json();
        questionOrder = data.questions;

        form.innerHTML = '';

        questionOrder.forEach((q, i) => {
          const block = document.createElement('div');
          block.className = 'question-block';
          block.innerHTML = `
            <label>${q.text}</label>
            <div class="slider-container">
              <span class="slider-label">あまり似ていない</span>
              <input type="range" name="q${i + 1}" min="1" max="7" value="4">
              <span class="slider-label">とても似ている</span>
            </div>
          `;
          form.appendChild(block);
        });

        form.querySelectorAll('input[type="range"]').forEach(input => {
          input.addEventListener('input', fetchRanking);
        });

        fetchRanking(); // 初回ランキング
      } catch (e) {
        console.error('❌ 質問の取得に失敗:', e);
        form.innerHTML = '<p>質問の取得に失敗しました。</p>';
      }
    }

    async function fetchRanking() {
      const formData = new FormData(form);
    
      // ▼ 質問の軸（axis）をフォームデータに追加
      questionOrder.forEach((q, i) => {
        formData.append(`axis${i + 1}`, q.axis);
      });
    
      try {
        const res = await fetch('/api/rank', {
          method: 'POST',
          body: formData
        });
    
        const htmlData = await res.text();
    
        tableView.innerHTML = htmlData;
    
        if (isMobile()) {
          generateCardsFromTable();
          tableView.style.display = "none";
          cardView.style.display = "block";
        } else {
          tableView.style.display = "block";
          cardView.style.display = "none";
        }
      } catch (error) {
        console.error("❌ fetch エラー:", error);
        tableView.innerHTML = "<p>データ取得に失敗しました。</p>";
        cardView.innerHTML = "";
      }
    }

    function generateCardsFromTable() {
      const table = document.querySelector("#table-view table");
      if (!table) {
        cardView.innerHTML = "<p>表示できるデータがありません。</p>";
        return;
      }

      const rows = table.querySelectorAll("tbody tr");
      const cardsHtml = [];

      rows.forEach((row, index) => {
        const cells = row.querySelectorAll("td");
        if (cells.length < 4) return;

        const name = cells[0].innerHTML;
        const colorHTML = cells[1].innerHTML;
        const value = cells[2].innerText;
        const score = cells[3].innerText;

        const cardId = `card-${index}`;

        cardsHtml.push(`
          <div class="accordion-card" id="accordion-${index}">
            <div class="accordion-header" onclick="toggleAccordion(${index})">
              <div class="accordion-header-top">
                <h3>${name}</h3>
                <div class="color-block-wrapper">${colorHTML}</div>
              </div>
            </div>
            <div class="accordion-body card-detail" id="${cardId}">
              <p class="value">${value}</p>
              <p class="score">スコア：<strong>${score}</strong></p>
            </div>
          </div>
        `);
      });

      cardView.innerHTML = cardsHtml.join('');
    }

    function toggleAccordion(index) {
      const card = document.getElementById(`accordion-${index}`);
      const detail = document.getElementById(`card-${index}`);
      card.classList.toggle('open');
      detail.classList.toggle('open');
    }

    document.getElementById('more-button').addEventListener('click', () => {
      window.location.href = '/desc_answer';
    });

    window.onload = fetchQuestionsAndRenderForm;
  </script>
</body>
</html>
