<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>ä¾¡å€¤è¦³ãƒãƒƒãƒãƒ³ã‚°</title>
  <link rel="stylesheet" href="/static/style.css" />
</head>
<body>
  <h1>ğŸ§­ ä¾¡å€¤è¦³ãƒãƒƒãƒãƒ³ã‚°ï¼šã‚ãªãŸã«åˆã†ä¼šç¤¾ã¯ï¼Ÿ</h1>
  <h2>ğŸ§© ã‚ãªãŸã«åˆã„ãã†ãªä¼šç¤¾ãƒ©ãƒ³ã‚­ãƒ³ã‚°ï¼ˆç°¡æ˜“ï¼‰</h2>

  <div id="table-view"></div>
  <div id="card-view" style="display: none;"></div>

  <h4>ä»¥ä¸‹ã®ä¼šç¤¾ãŒã©ã®ãã‚‰ã„è‡ªåˆ†ã¨ä¼¼ã¦ã„ã‚‹ã‹ã€å„é …ç›®ã”ã¨ã«å›ç­”ã—ã¦ãã ã•ã„</h4>

  <form id="preference-form"></form>

  <div id="more-section">
    <button id="more-button">ã‚‚ã£ã¨è¦‹ã‚‹</button>
  </div>

  <script>
    const form = document.getElementById('preference-form');
    const tableView = document.getElementById('table-view');
    const cardView = document.getElementById('card-view');

    let questionOrder = []; // ãƒ©ãƒ³ãƒ€ãƒ ãªé †ç•ª

    function isMobile() {
      return window.innerWidth <= 768;
    }

    async function fetchQuestionsAndRenderForm() {
      try {
        const res = await fetch('/api/questions');
        const data = await res.json();
        questionOrder = data.questions;

        form.innerHTML = '';

        questionOrder.forEach((q, i) => {
          const block = document.createElement('div');
          block.className = 'question-block';
          block.innerHTML = `
            <label>${q.text}</label>
            <div class="slider-container">
              <span class="slider-label">ã‚ã¾ã‚Šä¼¼ã¦ã„ãªã„</span>
              <input type="range" name="q${i + 1}" min="1" max="7" value="4">
              <span class="slider-label">ã¨ã¦ã‚‚ä¼¼ã¦ã„ã‚‹</span>
            </div>
          `;
          form.appendChild(block);
        });

        form.querySelectorAll('input[type="range"]').forEach(input => {
          input.addEventListener('input', fetchRanking);
        });

        fetchRanking(); // åˆå›ãƒ©ãƒ³ã‚­ãƒ³ã‚°
      } catch (e) {
        console.error('âŒ è³ªå•ã®å–å¾—ã«å¤±æ•—:', e);
        form.innerHTML = '<p>è³ªå•ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸã€‚</p>';
      }
    }

    async function fetchRanking() {
      const formData = new FormData(form);
    
      // â–¼ è³ªå•ã®è»¸ï¼ˆaxisï¼‰ã‚’ãƒ•ã‚©ãƒ¼ãƒ ãƒ‡ãƒ¼ã‚¿ã«è¿½åŠ 
      questionOrder.forEach((q, i) => {
        formData.append(`axis${i + 1}`, q.axis);
      });
    
      try {
        const res = await fetch('/api/rank', {
          method: 'POST',
          body: formData
        });
    
        const htmlData = await res.text();
    
        tableView.innerHTML = htmlData;
    
        if (isMobile()) {
          generateCardsFromTable();
          tableView.style.display = "none";
          cardView.style.display = "block";
        } else {
          tableView.style.display = "block";
          cardView.style.display = "none";
        }
      } catch (error) {
        console.error("âŒ fetch ã‚¨ãƒ©ãƒ¼:", error);
        tableView.innerHTML = "<p>ãƒ‡ãƒ¼ã‚¿å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸã€‚</p>";
        cardView.innerHTML = "";
      }
    }

    function generateCardsFromTable() {
      const table = document.querySelector("#table-view table");
      if (!table) {
        cardView.innerHTML = "<p>è¡¨ç¤ºã§ãã‚‹ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“ã€‚</p>";
        return;
      }

      const rows = table.querySelectorAll("tbody tr");
      const cardsHtml = [];

      rows.forEach((row, index) => {
        const cells = row.querySelectorAll("td");
        if (cells.length < 4) return;

        const name = cells[0].innerHTML;
        const colorHTML = cells[1].innerHTML;
        const value = cells[2].innerText;
        const score = cells[3].innerText;

        const cardId = `card-${index}`;

        cardsHtml.push(`
          <div class="accordion-card" id="accordion-${index}">
            <div class="accordion-header" onclick="toggleAccordion(${index})">
              <div class="accordion-header-top">
                <h3>${name}</h3>
                <div class="color-block-wrapper">${colorHTML}</div>
              </div>
            </div>
            <div class="accordion-body card-detail" id="${cardId}">
              <p class="value">${value}</p>
              <p class="score">ã‚¹ã‚³ã‚¢ï¼š<strong>${score}</strong></p>
            </div>
          </div>
        `);
      });

      cardView.innerHTML = cardsHtml.join('');
    }

    function toggleAccordion(index) {
      const card = document.getElementById(`accordion-${index}`);
      const detail = document.getElementById(`card-${index}`);
      card.classList.toggle('open');
      detail.classList.toggle('open');
    }

    document.getElementById('more-button').addEventListener('click', () => {
      window.location.href = '/desc_answer';
    });

    window.onload = fetchQuestionsAndRenderForm;
  </script>
</body>
</html>
