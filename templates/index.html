<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>価値観マッチング</title>
  <link rel="stylesheet" href="/static/style.css">
</head>
<body>
  <h1>🧭 価値観マッチング：あなたに合う会社は？</h1>
  <h2>🧩 あなたに合いそうな会社ランキング（簡易）</h2>

  <!-- PC表示用テーブル -->
  <div id="table-view"></div>

  <!-- スマホ表示用カード -->
  <div id="card-view" style="display: none;"></div>

  <h4>以下の会社がどのくらい自分と似ているか、各項目ごとに回答してください</h4>
  <form id="preference-form">
    <div class="question-block">
      <label>この会社は、自分で考え、自分のやり方で仕事を進めることを重視している</label>
      <div class="slider-container">
        <span class="slider-label">あまり似ていない</span>
        <input type="range" name="q1" min="1" max="7" value="4">
        <span class="slider-label">とても似ている</span>
      </div>
    </div>

    <div class="question-block">
      <label>この会社は、運営が安定していることや、状況が予測可能であること重視している</label>
      <div class="slider-container">
        <span class="slider-label">あまり似ていない</span>
        <input type="range" name="q2" min="1" max="7" value="4">
        <span class="slider-label">とても似ている</span>
      </div>
    </div>

    <div class="question-block">
      <label>この会社は、多様性、環境、人権、公平さなどを重視している</label>
      <div class="slider-container">
        <span class="slider-label">あまり似ていない</span>
        <input type="range" name="q3" min="1" max="7" value="4">
        <span class="slider-label">とても似ている</span>
      </div>
    </div>
  </form>

  <script>
    const form = document.getElementById('preference-form');
    const tableView = document.getElementById('table-view');
    const cardView = document.getElementById('card-view');

    function isMobile() {
      return window.innerWidth <= 768;
    }

    async function fetchRanking() {
      const formData = new FormData(form);
      const query = new URLSearchParams(formData).toString();

      try {
        const res = await fetch(`/api/rank?${query}`);
        const htmlData = await res.text();

        console.log("✅ データ取得成功");

        tableView.innerHTML = htmlData;

        if (isMobile()) {
          generateCardsFromTable();
          tableView.style.display = "none";
          cardView.style.display = "block";
        } else {
          tableView.style.display = "block";
          cardView.style.display = "none";
        }
      } catch (error) {
        console.error("❌ fetch エラー:", error);
        tableView.innerHTML = "<p>データ取得に失敗しました。</p>";
        cardView.innerHTML = "";
      }
    }

    function generateCardsFromTable() {
      const table = document.querySelector("#table-view table");
      if (!table) {
        cardView.innerHTML = "<p>表示できるデータがありません。</p>";
        return;
      }

      const rows = table.querySelectorAll("tbody tr");
      const cardsHtml = [];

      rows.forEach((row, index) => {
        const cells = row.querySelectorAll("td");
        if (cells.length < 4) return;

        const name = cells[0].querySelector("a")?.outerHTML || cells[0].innerText;
        const colorHTML = cells[1].innerHTML;
        const value = cells[2].innerText;
        const score = cells[3].innerText;

        const id = `card-detail-${index}`;

        cardsHtml.push(`
          <div class="card accordion-card" onclick="toggleDetail('${id}')">
            <h3>${name}</h3>
            <div class="color-block">${colorHTML}</div>
            <p class="score">スコア：<strong>${score}</strong></p>
            <div class="card-detail" id="${id}">
              <p class="value">${value}</p>
            </div>
          </div>
        `);
      });

      cardView.innerHTML = cardsHtml.join('');
    }

    function toggleDetail(id) {
      const el = document.getElementById(id);
      if (!el) return;
      el.style.display = el.style.display === "block" ? "none" : "block";
    }

    window.onload = fetchRanking;

    form.querySelectorAll('input[type="range"]').forEach(input => {
      input.addEventListener('input', fetchRanking);
    });
  </script>
</body>
</html>
